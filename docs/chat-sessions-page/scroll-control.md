# 滚动控制功能

## 概述

聊天页面提供智能滚动控制功能，包括自动滚动和手动滚动按钮，提升用户体验。

## 功能特性

### 1. 智能自动滚动

新消息到达时，系统会智能判断是否需要自动滚动：

- ✅ **用户在底部附近**（距离底部 < 150px）：自动滚动到底部，查看最新消息
- ❌ **用户在查看历史消息**（距离底部 >= 150px）：不自动滚动，避免打断阅读

这种智能行为确保用户在查看历史消息时不会被新消息打断，同时在正常聊天时能及时看到新消息。

### 2. 快速导航按钮

提供两个浮动按钮，方便用户快速导航：

#### 滚动到顶部按钮

- **显示条件**: 距离顶部 > 100px
- **功能**: 点击后平滑滚动到消息列表顶部
- **图标**: ↑ (UpOutlined)
- **位置**: 右下角

#### 滚动到底部按钮

- **显示条件**: 距离底部 > 100px
- **功能**: 点击后平滑滚动到消息列表底部
- **图标**: ↓ (DownOutlined)
- **位置**: 右下角

### 3. 动态显示/隐藏

按钮会根据滚动位置动态显示或隐藏：

- 在顶部时：只显示"滚动到底部"按钮
- 在底部时：只显示"滚动到顶部"按钮
- 在中间时：两个按钮都显示
- 接近顶部或底部时：对应按钮自动隐藏

## 使用方式

### 自动滚动

无需任何操作，系统会自动处理：

1. 发送消息后自动滚动到底部
2. 收到新消息时，如果在底部附近会自动滚动
3. 查看历史消息时不会被打断

### 手动滚动

使用浮动按钮快速导航：

1. 点击 ↑ 按钮快速回到顶部
2. 点击 ↓ 按钮快速回到底部
3. 按钮有 tooltip 提示，鼠标悬停可查看

## 技术实现

### useScroll Hook

封装了所有滚动控制逻辑：

```tsx
const {
  scrollContainerRef,    // 滚动容器引用
  scrollToTop,           // 滚动到顶部方法
  scrollToBottom,        // 滚动到底部方法
  showScrollToTop,       // 是否显示"滚动到顶部"按钮
  showScrollToBottom,    // 是否显示"滚动到底部"按钮
} = useScroll(messages);
```

### 关键参数

- **自动滚动阈值**: 150px（距离底部）
- **按钮显示阈值**: 100px（距离顶部/底部）
- **滚动行为**: smooth（平滑滚动）
- **延迟时间**: 100ms（确保 DOM 更新）

## 可访问性

### ARIA 属性

- 消息列表容器：`role="log"` 和 `aria-live="polite"`
- 滚动按钮：`aria-label` 描述按钮功能
- Tooltip：鼠标悬停显示按钮说明

### 键盘支持

虽然滚动按钮主要通过鼠标操作，但消息列表支持键盘滚动：

- `↑/↓` 方向键：滚动消息列表
- `Page Up/Down`：快速翻页
- `Home/End`：跳转到顶部/底部

## 性能优化

1. **useCallback**: 缓存滚动函数，避免不必要的重渲染
2. **条件渲染**: 按钮不需要时不渲染，节省性能
3. **事件清理**: 组件卸载时移除事件监听器
4. **防抖**: 滚动事件处理已优化，不会频繁触发状态更新

## 常见问题

### Q: 为什么新消息有时不自动滚动？

A: 这是智能滚动的设计。当你在查看历史消息时（距离底部 >= 150px），系统不会自动滚动，避免打断你的阅读。如果想查看最新消息，点击"滚动到底部"按钮即可。

### Q: 如何调整自动滚动的阈值？

A: 阈值定义在 `useScroll` hook 中，可以修改以下值：

- 自动滚动阈值：`distanceFromBottom < 150`
- 按钮显示阈值：`distanceFromTop > 100` 和 `distanceFromBottom > 100`

### Q: 滚动按钮可以自定义位置吗？

A: 可以。在 `ChatScrollButtons` 组件中修改 `FloatButton.Group` 的 `style` 属性：

```tsx
<FloatButton.Group style={{ right: 24, bottom: 24 }}>
```

### Q: 如何禁用自动滚动？

A: 在 `useScroll` hook 中注释掉自动滚动的 `useEffect`，或者将阈值设置为 0：

```tsx
if (distanceFromBottom < 0) { // 永远不会自动滚动
  // ...
}
```

## 浏览器兼容性

- **Chrome/Edge**: 完全支持
- **Firefox**: 完全支持
- **Safari**: 完全支持
- **IE11**: 不支持 `behavior: 'smooth'`，会降级为瞬间滚动

## 移动端适配

FloatButton 在移动端会自动调整大小和位置，但可能需要进一步优化：

- 调整按钮大小以适应触摸操作
- 调整按钮位置避免遮挡内容
- 考虑使用手势滚动替代按钮

## 相关文档

- [任务 6 实现总结](./task-6-summary.md)
- [聊天页面 README](../../src/pages/chat/README.md)
- [useScroll Hook 源码](../../src/hooks/chat/useScroll.ts)
- [ChatScrollButtons 组件源码](../../src/pages/chat/components/ChatScrollButtons/index.tsx)
