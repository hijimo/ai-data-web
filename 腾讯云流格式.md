# 腾讯云流式输出数据格式分析

## 概述

腾讯云采用 **SSE (Server-Sent Events)** 格式进行流式数据传输。每条消息以 `data:` 开头,包含 JSON 格式的数据。

## 数据格式结构

### 基础消息格式

```
data:{JSON数据}
```

每条消息都是一个完整的 JSON 对象,包含以下核心字段:

```json
{
  "completion_id": "string",      // 本次对话的唯一标识
  "session_id": "string",         // 会话ID(可能为空)
  "processes": {                  // 处理过程信息
    "stage": "string",            // 当前阶段
    "message": "string",          // 阶段描述信息
    "delta_content": "string",    // 增量内容(思考阶段使用)
    "content": "string",          // 完整内容
    "detail": object|null         // 详细信息
  },
  "delta_content": "string",      // 增量输出内容
  "content": "string",            // 完整内容
  "finish_reason": "string",      // 结束原因
  "is_stop": boolean,             // 是否停止
  "answer_source": "string",      // 答案来源
  "additional_content": object|null  // 附加内容
}
```

## 流程阶段 (stage)

### 1. 工具调用阶段

#### tool_call_start - 开始调用工具

```json
{
  "processes": {
    "stage": "tool_call_start",
    "message": "正在调用工具...",
    "delta_content": "",
    "content": "",
    "detail": {
      "tool_name": "search_docs",
      "tool_id": "tool-uuid"
    }
  }
}
```

#### tool_call_progress - 工具调用进行中

```json
{
  "processes": {
    "stage": "tool_call_progress",
    "message": "工具执行中...",
    "delta_content": "",
    "content": "",
    "detail": {
      "tool_name": "search_docs",
      "tool_id": "tool-uuid",
      "progress": 50
    }
  }
}
```

#### tool_call_complete - 工具调用完成

```json
{
  "processes": {
    "stage": "tool_call_complete",
    "message": "工具调用完成",
    "delta_content": "",
    "content": "",
    "detail": {
      "tool_name": "search_docs",
      "tool_id": "tool-uuid",
      "result": {
        "status": "success",
        "data": {}
      }
    }
  }
}
```

#### tool_call_error - 工具调用失败

```json
{
  "processes": {
    "stage": "tool_call_error",
    "message": "工具调用失败",
    "delta_content": "",
    "content": "",
    "detail": {
      "tool_name": "search_docs",
      "tool_id": "tool-uuid",
      "error": {
        "code": "TOOL_ERROR",
        "message": "工具执行失败"
      }
    }
  }
}
```

### 2. 搜索/检索阶段

#### internal_searching - 正在搜索

```json
{
  "processes": {
    "stage": "internal_searching",
    "message": "正在搜索"聚工单"",
    "delta_content": "",
    "content": "",
    "detail": {
      "space_name": "聚工单"
    }
  }
}
```

#### finished_internal_searching - 搜索完成

```json
{
  "processes": {
    "stage": "finished_internal_searching",
    "message": "搜索到"聚工单"的 14 篇资料",
    "delta_content": "",
    "content": "",
    "detail": {
      "space_count": 1,
      "doc_count": 14,
      "space_name": "聚工单"
    }
  },
  "additional_content": {
    "context_limit_reference_chunks_top_n": 9,
    "reference_chunks": [
      {
        "block_id": "",
        "content": "文档内容...",
        "content_with_mllm": "带MLLM处理的内容...",
        "file_info": {
          "target_id": "string",
          "target_type": "kb_file"
        },
        "file_pages": null,
        "file_type": "md",
        "meeting_info": {
          "cover_url": "",
          "start_time": 0
        },
        "owner": {
          "avatar": "url",
          "display_name": "name"
        },
        "space_info": {
          "id": "string",
          "name": "string"
        },
        "target_id": "string",
        "target_type": "kb_entry",
        "title": "文档标题",
        "updated_at": 1761267312,
        "url": "/pages/xxx"
      }
    ]
  }
}
```

### 3. 资源检索阶段（可选）

#### resource_retrieval_start - 开始检索资源

```json
{
  "processes": {
    "stage": "resource_retrieval_start",
    "message": "正在检索相关资源...",
    "delta_content": "",
    "content": "",
    "detail": {
      "query": "检索关键词",
      "resource_type": "document"
    }
  }
}
```

#### resource_retrieval_complete - 资源检索完成

```json
{
  "processes": {
    "stage": "resource_retrieval_complete",
    "message": "资源检索完成",
    "delta_content": "",
    "content": "",
    "detail": {
      "resource_count": 5,
      "resources": []
    }
  }
}
```

### 4. 思考阶段

#### thinking - 正在思考

```json
{
  "processes": {
    "stage": "thinking",
    "message": "正在根据资料进行深度思考...",
    "delta_content": "或",  // 每次返回一个词或字
    "content": "",
    "detail": null
  },
  "delta_content": "",
  "content": "",
  "finish_reason": "",
  "is_stop": false
}
```

**特点**:

- `processes.delta_content` 包含思考过程的增量文本
- 每条消息通常只包含一个词或几个字
- `stage` 为 "thinking"

### 5. 输出阶段

#### 空 stage - 正式输出

```json
{
  "processes": {
    "stage": "",
    "message": "",
    "delta_content": "",
    "content": "",
    "detail": null
  },
  "delta_content": "类型",  // 实际输出的增量内容
  "content": "",
  "finish_reason": "",
  "is_stop": false
}
```

**特点**:

- `processes.stage` 为空字符串
- `delta_content` 包含实际输出的增量文本
- 每条消息通常包含一个词或几个字

### 6. 结束阶段

#### finish 事件

```
event:finish
data:{完整的响应数据}
```

**完整响应数据结构**:

```json
{
  "completion_id": "7e016b24c1b0496dbb74ba4344d8b373",
  "session_id": "5806b515a2d62186b59a066f3fdbc93c00f95d0c",
  "processes": {
    "stage": "",
    "message": "",
    "delta_content": "",
    "content": "",
    "detail": null
  },
  "delta_content": "",
  "content": "完整的回答内容(包含HTML标签和引用)",
  "finish_reason": "stop",
  "is_stop": true,
  "answer_source": "internal-space",
  "additional_content": {
    "generated_question": "",
    "reference_docs": [
      {
        "block_id": "",
        "file_type": "md",
        "target_id": "string",
        "target_type": "kb_entry",
        "title": "文档标题",
        "url": "/pages/xxx"
      }
    ],
    "scenario": "qa"
  }
}
```

## 关键字段说明

### completion_id

- 类型: string
- 说明: 本次对话的唯一标识,整个流程中保持不变

### session_id

- 类型: string
- 说明: 会话ID,在流程开始时可能为空,在finish事件中会返回

### processes.stage

- 类型: string
- 可能值:
  - `"internal_searching"` - 正在搜索知识库
  - `"finished_internal_searching"` - 搜索完成
  - `"thinking"` - 正在思考
  - `""` - 正式输出阶段

### delta_content

- 类型: string
- 说明: 增量输出内容
- 在thinking阶段: 为空
- 在输出阶段: 包含实际输出的文本片段

### processes.delta_content

- 类型: string
- 说明: 思考过程的增量内容
- 仅在thinking阶段有值

### content

- 类型: string
- 说明: 完整内容
- 在流式输出过程中通常为空
- 在finish事件中包含完整的回答(包含HTML标签和引用标记)

### finish_reason

- 类型: string
- 可能值:
  - `""` - 未结束
  - `"stop"` - 正常结束

### is_stop

- 类型: boolean
- 说明: 是否停止输出
- `false` - 继续输出
- `true` - 输出结束

### answer_source

- 类型: string
- 可能值:
  - `"internal-space"` - 来自内部知识库
  - `""` - 其他来源

### additional_content

- 类型: object | null
- 说明: 附加内容
- 在搜索完成阶段: 包含 `reference_chunks` (引用的文档片段)
- 在finish阶段: 包含 `reference_docs` (引用的文档列表)

## 完整流程示例

### 示例1: 带工具调用的完整流程

#### 阶段1: 开始调用工具

```json
{
  "completion_id": "xxx",
  "session_id": "",
  "processes": {
    "stage": "tool_call_start",
    "message": "正在调用搜索工具...",
    "detail": {
      "tool_name": "search_docs",
      "tool_id": "tool-001"
    }
  },
  "is_stop": false
}
```

#### 阶段2: 工具调用完成

```json
{
  "completion_id": "xxx",
  "session_id": "",
  "processes": {
    "stage": "tool_call_complete",
    "message": "工具调用完成",
    "detail": {
      "tool_name": "search_docs",
      "tool_id": "tool-001",
      "result": {
        "status": "success",
        "data": {
          "doc_count": 14
        }
      }
    }
  },
  "is_stop": false
}
```

#### 阶段3: 思考过程

```json
{
  "completion_id": "xxx",
  "processes": {
    "stage": "thinking",
    "message": "正在根据资料进行深度思考...",
    "delta_content": "手工"
  },
  "is_stop": false
}
```

#### 阶段4: 输出内容

```json
{
  "completion_id": "xxx",
  "processes": {
    "stage": "",
    "message": ""
  },
  "delta_content": "聚工单",
  "is_stop": false
}
```

#### 阶段5: 结束

```
event:finish
data:{
  "completion_id": "xxx",
  "session_id": "yyy",
  "content": "完整的回答内容...",
  "finish_reason": "stop",
  "is_stop": true,
  "additional_content": {
    "reference_docs": [...]
  }
}
```

### 示例2: 知识库搜索流程（无工具调用）

#### 阶段1: 开始搜索

```json
{
  "completion_id": "xxx",
  "session_id": "",
  "processes": {
    "stage": "internal_searching",
    "message": "正在搜索"聚工单"",
    "detail": {"space_name": "聚工单"}
  },
  "is_stop": false
}
```

#### 阶段2: 搜索完成

```json
{
  "completion_id": "xxx",
  "session_id": "",
  "processes": {
    "stage": "finished_internal_searching",
    "message": "搜索到"聚工单"的 14 篇资料",
    "detail": {
      "space_count": 1,
      "doc_count": 14,
      "space_name": "聚工单"
    }
  },
  "additional_content": {
    "reference_chunks": [...]
  },
  "is_stop": false
}
```

#### 阶段3: 思考过程

```json
{
  "completion_id": "xxx",
  "processes": {
    "stage": "thinking",
    "message": "正在根据资料进行深度思考...",
    "delta_content": "手工"
  },
  "is_stop": false
}
```

#### 阶段4: 输出内容

```json
{
  "completion_id": "xxx",
  "processes": {
    "stage": "",
    "message": ""
  },
  "delta_content": "聚工单",
  "is_stop": false
}
```

#### 阶段5: 结束

```
event:finish
data:{
  "completion_id": "xxx",
  "session_id": "yyy",
  "content": "完整的回答内容...",
  "finish_reason": "stop",
  "is_stop": true,
  "additional_content": {
    "reference_docs": [...]
  }
}
```

## 工具调用与搜索的区别

### 工具调用 (Tool Call)

- **用途**: 执行外部操作或获取外部数据
- **Stage**: `tool_call_start`, `tool_call_progress`, `tool_call_complete`, `tool_call_error`
- **特点**:
  - 可以调用任意外部工具（API、数据库、计算服务等）
  - 支持进度报告
  - 有明确的成功/失败状态
  - 可以返回结构化数据
- **应用场景**:
  - 调用外部API
  - 执行计算任务
  - 数据库查询
  - 文件操作

### 知识库搜索 (Internal Search)

- **用途**: 在内部知识库中检索相关文档
- **Stage**: `internal_searching`, `finished_internal_searching`
- **特点**:
  - 专门用于知识库检索
  - 返回文档片段和引用
  - 包含文档元数据（标题、URL、更新时间等）
  - 自动关联到答案生成
- **应用场景**:
  - RAG（检索增强生成）
  - 文档问答
  - 知识库查询

### 资源检索 (Resource Retrieval)

- **用途**: 通用的资源检索操作
- **Stage**: `resource_retrieval_start`, `resource_retrieval_complete`
- **特点**:
  - 比知识库搜索更通用
  - 可以检索多种类型的资源
  - 支持自定义检索逻辑
- **应用场景**:
  - 向量数据库检索
  - 多源数据聚合
  - 自定义检索引擎

## 注意事项

1. **编码问题**: 所有文本都是UTF-8编码,中文字符可能被分割成多个字节
2. **空行**: SSE格式中可能包含空行,需要跳过
3. **事件类型**: 只有finish事件有 `event:` 前缀
4. **引用标记**: 完整内容中包含HTML标签,如 `<span id="ai-qa-ref">` 用于标记引用
5. **思考过程**: `thinking` 阶段的内容在 `processes.delta_content` 中,不在 `delta_content` 中
6. **完整内容**: 最终的 `content` 字段包含完整的格式化内容(Markdown + HTML)

## 数据结构定义 (Go)

```go
type TencentCloudMessage struct {
    CompletionID      string                 `json:"completion_id"`
    SessionID         string                 `json:"session_id"`
    Processes         ProcessInfo            `json:"processes"`
    DeltaContent      string                 `json:"delta_content"`
    Content           string                 `json:"content"`
    FinishReason      string                 `json:"finish_reason"`
    IsStop            bool                   `json:"is_stop"`
    AnswerSource      string                 `json:"answer_source"`
    AdditionalContent *AdditionalContent     `json:"additional_content"`
}

type ProcessInfo struct {
    Stage        string      `json:"stage"`
    Message      string      `json:"message"`
    DeltaContent string      `json:"delta_content"`
    Content      string      `json:"content"`
    Detail       interface{} `json:"detail"` // 可以是 SearchDetail, ToolCallDetail, ResourceRetrievalDetail 等
}

// 搜索详情
type SearchDetail struct {
    SpaceName  string `json:"space_name,omitempty"`
    SpaceCount int    `json:"space_count,omitempty"`
    DocCount   int    `json:"doc_count,omitempty"`
}

// 工具调用详情
type ToolCallDetail struct {
    ToolName string                 `json:"tool_name"`
    ToolID   string                 `json:"tool_id"`
    Progress int                    `json:"progress,omitempty"` // 0-100
    Result   *ToolCallResult        `json:"result,omitempty"`
    Error    *ToolCallError         `json:"error,omitempty"`
}

type ToolCallResult struct {
    Status string      `json:"status"` // "success" or "error"
    Data   interface{} `json:"data"`
}

type ToolCallError struct {
    Code    string `json:"code"`
    Message string `json:"message"`
}

// 资源检索详情
type ResourceRetrievalDetail struct {
    Query         string `json:"query"`
    ResourceType  string `json:"resource_type"`
    ResourceCount int    `json:"resource_count,omitempty"`
    Resources     []interface{} `json:"resources,omitempty"`
}

type AdditionalContent struct {
    ContextLimitReferenceChunksTopN int              `json:"context_limit_reference_chunks_top_n,omitempty"`
    ReferenceChunks                 []ReferenceChunk `json:"reference_chunks,omitempty"`
    GeneratedQuestion               string           `json:"generated_question,omitempty"`
    ReferenceDocs                   []ReferenceDoc   `json:"reference_docs,omitempty"`
    Scenario                        string           `json:"scenario,omitempty"`
}

type ReferenceChunk struct {
    BlockID         string      `json:"block_id"`
    Content         string      `json:"content"`
    ContentWithMLLM string      `json:"content_with_mllm"`
    FileInfo        FileInfo    `json:"file_info"`
    FilePages       interface{} `json:"file_pages"`
    FileType        string      `json:"file_type"`
    MeetingInfo     MeetingInfo `json:"meeting_info"`
    Owner           Owner       `json:"owner"`
    SpaceInfo       SpaceInfo   `json:"space_info"`
    TargetID        string      `json:"target_id"`
    TargetType      string      `json:"target_type"`
    Title           string      `json:"title"`
    UpdatedAt       int64       `json:"updated_at"`
    URL             string      `json:"url"`
}

type ReferenceDoc struct {
    BlockID    string `json:"block_id"`
    FileType   string `json:"file_type"`
    TargetID   string `json:"target_id"`
    TargetType string `json:"target_type"`
    Title      string `json:"title"`
    URL        string `json:"url"`
}

type FileInfo struct {
    TargetID   string `json:"target_id"`
    TargetType string `json:"target_type"`
}

type MeetingInfo struct {
    CoverURL  string `json:"cover_url"`
    StartTime int64  `json:"start_time"`
}

type Owner struct {
    Avatar      string `json:"avatar"`
    DisplayName string `json:"display_name"`
}

type SpaceInfo struct {
    ID   string `json:"id"`
    Name string `json:"name"`
}
```

---

## Stage 类型汇总

### 工具调用相关

| Stage | 说明 | Detail 字段 |
|-------|------|------------|
| `tool_call_start` | 开始调用工具 | `tool_name`, `tool_id` |
| `tool_call_progress` | 工具调用进行中 | `tool_name`, `tool_id`, `progress` |
| `tool_call_complete` | 工具调用完成 | `tool_name`, `tool_id`, `result` |
| `tool_call_error` | 工具调用失败 | `tool_name`, `tool_id`, `error` |

### 搜索/检索相关

| Stage | 说明 | Detail 字段 |
|-------|------|------------|
| `internal_searching` | 正在搜索知识库 | `space_name` |
| `finished_internal_searching` | 搜索完成 | `space_name`, `space_count`, `doc_count` |
| `resource_retrieval_start` | 开始检索资源 | `query`, `resource_type` |
| `resource_retrieval_complete` | 资源检索完成 | `resource_count`, `resources` |

### 生成相关

| Stage | 说明 | Detail 字段 |
|-------|------|------------|
| `thinking` | 正在思考 | `null` |
| `""` (空字符串) | 正式输出 | `null` |

### 结束相关

| Event | 说明 | 备注 |
|-------|------|------|
| `finish` | 流式输出结束 | 包含完整的 `content` 和 `additional_content` |
